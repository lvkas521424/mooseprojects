# Fortran外部程序编译 - 两种方式

## 🎯 简单回答你的问题

**是的，完全可以直接调用CMakeLists编译！**

你的项目现在支持**两种方式**：

---

## 方式1：CMake编译（当前默认，推荐）✅

### 使用方法

```bash
# 直接编译，CMake会自动处理依赖
make -j8
```

### 优点
- ✅ **零配置** - 你的CMakeLists.txt会自动被调用
- ✅ **自动依赖** - CMake自动处理.mod文件依赖
- ✅ **添加新文件** - 只需 `make -j8`，CMake自动检测

### 工作原理
```
make -j8
  ↓
自动调用: cd contrib/tran_heat && cmake ...
  ↓
CMake分析依赖 → 编译Fortran → 生成libtran_heat.a
  ↓
链接到mooseprojects主程序
  ↓
完成！
```

### 清理
```bash
make clean-tran_heat
```

---

## 方式2：直接编译（自动依赖分析）

### 切换方法

编辑 `mooseprojects.mk` 第12行：
```makefile
# 从
USE_CMAKE_FOR_FORTRAN ?= yes

# 改为
USE_CMAKE_FOR_FORTRAN ?= no
```

### 使用方法

```bash
# 首次或添加新文件后
make update-fortran-deps

# 编译
make -j8
```

### 优点
- ✅ **透明** - 可以看到完整的编译过程
- ✅ **灵活** - 可以手动调整编译参数
- ✅ **学习** - 理解Make和Fortran依赖

---

## 🚀 推荐用法

### 如果你的CMakeLists.txt已经配置好了

**👉 使用方式1（CMake）- 当前默认**

```bash
# 什么都不用改，直接用
make -j8
```

### 如果你想要更多控制权

**👉 切换到方式2（自动依赖分析）**

```bash
# 1. 修改 mooseprojects.mk: USE_CMAKE_FOR_FORTRAN ?= no
# 2. make update-fortran-deps
# 3. make -j8
```

---

## 📋 完整示例

### 使用CMake（推荐，零配置）

```bash
cd /home/lvkas/projects/mooseprojects

# 添加新的Fortran文件
cat > contrib/tran_heat/src/new_physics.f90 << 'EOF'
module new_physics
    implicit none
    ! 你的代码...
end module new_physics
EOF

# CMake会自动检测，直接编译
make -j8

# 完成！✅
```

### 使用自动依赖分析

```bash
cd /home/lvkas/projects/mooseprojects

# 1. 切换模式（编辑mooseprojects.mk）
# USE_CMAKE_FOR_FORTRAN ?= no

# 2. 添加新的Fortran文件
cat > contrib/tran_heat/src/new_physics.f90 << 'EOF'
module new_physics
    implicit none
    ! 你的代码...
end module new_physics
EOF

# 3. 更新依赖
make update-fortran-deps

# 4. 编译
make -j8

# 完成！✅
```

---

## 🔄 切换方式

### 永久切换

编辑 `mooseprojects.mk`：
```makefile
USE_CMAKE_FOR_FORTRAN ?= yes   # 使用CMake
# 或
USE_CMAKE_FOR_FORTRAN ?= no    # 使用自动依赖分析
```

### 临时切换（一次性）

```bash
# 临时使用CMake
make USE_CMAKE_FOR_FORTRAN=yes -j8

# 临时使用自动依赖
make USE_CMAKE_FOR_FORTRAN=no update-fortran-deps
make USE_CMAKE_FOR_FORTRAN=no -j8
```

---

## 🎓 对比总结

|  | CMake | 自动依赖分析 |
|---|------|------------|
| **命令** | `make -j8` | `make update-fortran-deps && make -j8` |
| **新增文件** | 自动检测 | 需运行update命令 |
| **依赖处理** | CMake自动 | Python脚本自动 |
| **配置文件** | CMakeLists.txt | tran_heat_auto.mk |
| **适合场景** | 大型已有项目 | 新项目或需要精细控制 |
| **当前默认** | ✅ | - |

---

## ✅ 结论

**你可以继续使用你熟悉的CMakeLists.txt！**

当前配置已经是CMake模式，什么都不用改，直接：

```bash
make -j8
```

所有的模块依赖都由CMake自动处理，无需担心`.mod`文件问题！

---

## 📚 详细文档

- `CMAKE_vs_DIRECT.md` - 两种方式的详细对比
- `README_FORTRAN.md` - 完整参考手册
- `AUTO_WORKFLOW.md` - 自动依赖分析工作流程
- `使用说明.txt` - 快速参考卡片

---

**有任何问题，直接运行：**
```bash
make debug-tran_heat    # 查看当前配置
make clean-tran_heat    # 清理重建
```

